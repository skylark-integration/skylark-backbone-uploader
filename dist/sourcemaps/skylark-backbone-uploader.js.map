{"version":3,"sources":["skylark-backbone-uploader.js"],"names":["define","Backbone","TemplateManager","templates","baseUrl","loadings","Array","currentViews","queues","set","name","data","this","queue","i","length","dfd","resolveWith","context","notLoading","index","indexOf","rest","slice","push","apply","get","$","Deferred","url","replace","template","_","error","promise","DeferedView","View","extend","templateName","container","loadedCountDown","deferedRender","event","then","resultTemplate","render","isLoaded","undefined","getHelpers","displaySize","bytes","parseInt","Math","floor","log","pow","toFixed","displayDate","timestamp","Date","toLocaleString","renderTo","close","html","el","loaded","addClass","removeClass","onPreClose","remove","unbind","onClose","uploader","UploadManager","defaults","main","file","uploadUrl","autoUpload","fileUploadId","startUploadsId","cancelUploadsId","dataType","file_id","className","initialize","options","files","FileCollection","bindLocal","self","on","add","renderFile","progress","fail","done","result","update","file_view","FileView","model","append","with_files_elements","without_files_elements","bindProcessEvents","input","uploadProcess","formData","singleFileUploads","picker","e","uploadManagerFiles","each","file_data","id","File","processor","trigger","errorThrown","message","click","at","cancel","start","Model","state","isPending","submit","abort","destroy","getState","isRunning","isDone","isError","Collection","processUploadMsg","doneMsg","updateProgress","hasFailed","hasDone","computeData","bindEvents","percent","total","progressHTML","find","css","parent","when_pending","when_running","when_done","collection"],"mappings":"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","file":"../skylark-backbone-uploader.js","sourcesContent":["/**\r\n * Backbone.js defered view loader\r\n *\r\n * @author Samuel ROZE\r\n * @link sroze.io\r\n * @link github.com/sroze\r\n */\r\ndefine(\"backbone-defered-view-loader\",[\r\n    \"skylark-backbone\"\r\n],function(Backbone) {\r\n    /**\r\n     * TemplateManager object provides an async template loading and caching\r\n     * system.\r\n     * \r\n     */\r\n    Backbone.TemplateManager = {\r\n        // Already loaded templates\r\n        templates: {},\r\n        \r\n        // Base loading template URL\r\n        baseUrl: '/templates/{name}',\r\n        \r\n        // Templates that are currently loading\r\n        loadings: new Array(),\r\n        \r\n        // Save current rendered views\r\n        currentViews: {},\r\n        \r\n        // Waiting defereds\r\n        queues: {},\r\n        \r\n        set: function (name, data) {\r\n            this.templates[name] = data;\r\n            \r\n            // Resolve queues\r\n            var queue = this.queues[name];\r\n            if (queue) {\r\n                for (var i = 0; i < queue.length; i++) {\r\n                    queue[i].dfd.resolveWith(queue[i].context, [data]);\r\n                }\r\n            }\r\n            this.queues[name] = new Array();\r\n        },\r\n        \r\n        notLoading: function (name) {\r\n            var index = this.loadings.indexOf(name);\r\n            if (index != -1) {\r\n                var rest = this.loadings.slice(index + 1 || this.loadings.length);\r\n                this.loadings.length = index < 0 ? this.loadings.length + index : index;\r\n                return this.loadings.push.apply(this, rest);\r\n            }\r\n        },\r\n        \r\n        get: function(name, context) \r\n        {\r\n            if (name == null) {\r\n                throw \"Template name must be defined\";\r\n            }\r\n            \r\n            var dfd = $.Deferred();\r\n            \r\n            // If the template is already loaded, resolve immediately\r\n            if (this.templates[name]) {\r\n                dfd.resolveWith(context, [this.templates[name]]);\r\n            } else {\r\n                // Add this request to queue\r\n                if (!this.queues[name]) {\r\n                    this.queues[name] = new Array();\r\n                }\r\n                this.queues[name].push({dfd: dfd, context: context});\r\n                \r\n                // Is this template loading ?\r\n                if (this.loadings.indexOf(name) == -1) {\r\n                    this.loadings.push(name);\r\n                    \r\n                    // Compute template URL\r\n                    var url = Backbone.TemplateManager.baseUrl.replace('{name}', name);\r\n                \r\n                    // Start template loading\r\n                    $.get(url, function (data) {\r\n                        // Compute template\r\n                        var template = _.template(data);\r\n                        \r\n                        // Save template in \"cache\"\r\n                        Backbone.TemplateManager.notLoading(name);\r\n                        Backbone.TemplateManager.set(name, template);\r\n                    }).error(function(){\r\n                        Backbone.TemplateManager.notLoading(name);\r\n                    });\r\n                }\r\n            }\r\n            \r\n            return dfd.promise();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Lmc.View improves the backbone model view, with async template\r\n     * loading for instance.\r\n     * \r\n     */\r\n    Backbone.DeferedView = Backbone.View.extend({\r\n        templateName: null,\r\n        container: null,\r\n        loadedCountDown: 1,\r\n        \r\n        deferedRender: function(event) {\r\n            // Fetch the template from the TemplateManager and when complete \r\n            // call the normal render method\r\n            var tn = this.templateName;\r\n            //var render = $.when(\r\n            //    Backbone.TemplateManager.get(this.templateName, this)\r\n            //).then(function(resultTemplate){\r\n            var render = Backbone.TemplateManager.get(this.templateName, this).\r\n                then(function(resultTemplate){\r\n                this.template = resultTemplate;\r\n                this.render();\r\n                this.isLoaded(true);\r\n                \r\n                if (event != undefined && typeof event == \"function\") {\r\n                    event();\r\n                }\r\n            });\r\n\r\n            return this;\r\n        },\r\n        \r\n        getHelpers: function () {\r\n            return {\r\n                displaySize: function (bytes) {\r\n                    var sizes = ['B', 'KB', 'MB', 'GB', 'TB'];\r\n                    if (bytes == 0) return '0 B';\r\n                    var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));\r\n                    return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];\r\n                },\r\n                displayDate: function (timestamp) {\r\n                    return new Date(timestamp).toLocaleString();\r\n                }\r\n            }\r\n        },\r\n        \r\n        renderTo: function (container, event) {\r\n            if (Backbone.TemplateManager.currentViews[container]){\r\n                Backbone.TemplateManager.currentViews[container].close();\r\n            }\r\n            \r\n            Backbone.TemplateManager.currentViews[container] = this;\r\n            this.isLoaded(false);\r\n            \r\n            $(container).html(this.deferedRender(event).el);\r\n            \r\n            return this;\r\n        },\r\n        \r\n        isLoaded: function (loaded) {\r\n            if (loaded != undefined) {\r\n                this.loadedCountDown += (loaded ? -1 : 1);\r\n                if (this.loadedCountDown > 0) {\r\n                    $(this.el).addClass('loading');\r\n                } else {\r\n                    $(this.el).removeClass('loading');\r\n                }\r\n            }\r\n            \r\n            return this.loadedCountDown == 0;\r\n        },\r\n        \r\n        close: function() {\r\n            if (typeof this.onPreClose == \"function\") {\r\n                this.onPreClose();\r\n            }\r\n            this.remove();\r\n            this.unbind();\r\n            if (typeof this.onClose == \"function\") {\r\n                this.onClose();\r\n            }\r\n        }\r\n    });\r\n});\ndefine(\"skylark-backbone-uploader/defered-view-loader\", function(){});\n\n\r\ndefine('skylark-backbone-uploader/upload-manager',[\r\n    \"skylark-utils-filer/uploader\",\r\n    \"skylark-backbone\",\r\n    \"./defered-view-loader\"\r\n],function(uploader,Backbone) {\r\n/**\r\n * Backbone Upload Manager v1.0.0\r\n *\r\n * Copyright (c) 2013 Samuel ROZE\r\n *\r\n * License and more information at:\r\n * http://github.com/sroze/backbone-upload-manager\r\n */\r\n\r\n    Backbone.UploadManager = Backbone.DeferedView.extend({\r\n        /**\r\n         * Default options, that will be merged with the passed.\r\n         *\r\n         */\r\n        defaults: {\r\n            templates: {\r\n                main: '/templates/upload-manager.main.default',\r\n                file: '/templates/upload-manager.file.default'\r\n            },\r\n            uploadUrl: '/upload',\r\n            autoUpload: false,\r\n            fileUploadId: 'fileupload',\r\n            startUploadsId: 'start-uploads-button',\r\n            cancelUploadsId: 'cancel-uploads-button',\r\n            dataType: 'json'\r\n        },\r\n\r\n        /**\r\n         * An integer used to track the files by a unique\r\n         * identifier.\r\n         *\r\n         */\r\n        file_id: 0,\r\n\r\n        /**\r\n         * View container class.\r\n         *\r\n         */\r\n        className: 'upload-manager',\r\n\r\n        /**\r\n         * Initialize upload manager options\r\n         *\r\n         */\r\n        initialize: function (options)\r\n        {\r\n            // Merge options\r\n            this.options = $.extend(this.defaults, options);\r\n\r\n            // Update template name\r\n            this.templateName = this.options.templates.main;\r\n\r\n            // Create the file list\r\n            this.files = new Backbone.UploadManager.FileCollection();\r\n\r\n            // Create the file-upload wrapper\r\n            /*\r\n            this.uploadProcess = $('<input id=\"' + this.options.fileUploadId + '\" type=\"file\" name=\"files[]\" multiple=\"multiple\">').fileupload({\r\n                dataType: this.options.dataType,\r\n                url: this.options.uploadUrl,\r\n                formData: this.options.formData,\r\n                autoUpload: this.options.autoUpload,\r\n                singleFileUploads: true\r\n            });\r\n\r\n            // Add upload process events handlers\r\n            this.bindProcessEvents();\r\n            */\r\n\r\n            // Add local events handlers\r\n            this.bindLocal();\r\n        },\r\n\r\n        /**\r\n         * Bind local events.\r\n         *\r\n         */\r\n        bindLocal: function ()\r\n        {\r\n            var self = this;\r\n            this.on('fileadd', function (file) {\r\n                // Add it to current list\r\n                self.files.add(file);\r\n\r\n                // Create the view\r\n                self.renderFile(file);\r\n            }).on('fileprogress', function (file, progress) {\r\n                file.progress(progress);\r\n            }).on('filefail', function (file, error) {\r\n                file.fail(error);\r\n            }).on('filedone', function (file, data) {\r\n                file.done(data.result);\r\n            });\r\n\r\n            // When collection changes\r\n            this.files.on('all', this.update, this);\r\n        },\r\n\r\n        /**\r\n         * Render a file.\r\n         *\r\n         */\r\n        renderFile: function (file)\r\n        {\r\n            var file_view = new Backbone.UploadManager.FileView($.extend(this.options, {model: file}));\r\n            $('#file-list', self.el).append(file_view.deferedRender().el);\r\n        },\r\n\r\n        /**\r\n         * Update the view without full rendering.\r\n         *\r\n         */\r\n        update: function ()\r\n        {\r\n            var with_files_elements = $('#' + this.options.cancelUploadsId + ', #' + this.options.startUploadsId, this.el);\r\n            var without_files_elements = $('#file-list .no-data', this.el);\r\n            if (this.files.length > 0) {\r\n                with_files_elements.removeClass('hidden');\r\n                without_files_elements.addClass('hidden');\r\n            } else {\r\n                with_files_elements.addClass('hidden');\r\n                without_files_elements.removeClass('hidden');\r\n            }\r\n        },\r\n\r\n        /**\r\n         * Bind events on the upload processor.\r\n         *\r\n         */\r\n        bindProcessEvents: function ()\r\n        {\r\n        },\r\n\r\n        /**\r\n         * Render the main part of upload manager.\r\n         *\r\n         */\r\n        render: function () {\r\n            var self = this;\r\n            $(this.el).html(this.template());\r\n\r\n            // Update view\r\n            this.update();\r\n\r\n            // Add add files handler\r\n            var input = $('.fileinput-button', this.el), self = this;\r\n\r\n            this.uploadProcess =  uploader(this.el,{  //$.$(this.el).fileupload({\r\n                dataType: this.options.dataType,\r\n                url: this.options.uploadUrl,\r\n                formData: this.options.formData,\r\n                autoUpload: this.options.autoUpload,\r\n                singleFileUploads: true,\r\n                picker : input,\r\n\r\n                'add' : function (e, data) {\r\n                    // Create an array in which the file objects\r\n                    // will be stored.\r\n                    data.uploadManagerFiles = [];\r\n\r\n                    // A file is added, process for each file.\r\n                    // Note: every times, the data.files array length is 1 because\r\n                    //       of \"singleFileUploads\" option.\r\n                    $.each(data.files, function (index, file_data) {\r\n                        // Create the file object\r\n                        file_data.id = self.file_id++;\r\n                        var file = new Backbone.UploadManager.File({\r\n                            data: file_data,\r\n                            processor: data\r\n                        });\r\n\r\n                        // Add file in data\r\n                        data.uploadManagerFiles.push(file);\r\n\r\n                        // Trigger event\r\n                        self.trigger('fileadd', file);\r\n                    });\r\n                },\r\n\r\n                'progress' : function (e, data) {\r\n                    $.each(data.uploadManagerFiles, function (index, file) {\r\n                        self.trigger('fileprogress', file, data);\r\n                    });\r\n                },\r\n\r\n                'fail' : function (e, data) {\r\n                    $.each(data.uploadManagerFiles, function (index, file) {\r\n                        var error = \"Unknown error\";\r\n                        if (typeof data.errorThrown == \"string\") {\r\n                            error = data.errorThrown;\r\n                        } else if (typeof data.errorThrown == \"object\") {\r\n                            error = data.errorThrown.message;\r\n                        } else if (data.result) {\r\n                            if (data.result.error) {\r\n                                error = data.result.error;\r\n                            } else if (data.result.files && data.result.files[index] && data.result.files[index].error) {\r\n                                error = data.result.files[index].error;\r\n                            } else {\r\n                                error = \"Unknown remote error\";\r\n                            }\r\n                        }\r\n\r\n                        self.trigger('filefail', file, error);\r\n                    });\r\n                },\r\n\r\n                'done' : function (e, data) {\r\n                    $.each(data.uploadManagerFiles, function (index, file) {\r\n                        self.trigger('filedone', file, data);\r\n                    });\r\n                }\r\n\r\n            });\r\n\r\n            // Add upload process events handlers\r\n            this.bindProcessEvents();\r\n\r\n            /*\r\n            input.on('change', function (){\r\n                self.uploadProcess.fileupload('add', {\r\n                    fileInput: $(this)\r\n                });\r\n            });\r\n            */\r\n\r\n            // Add cancel all handler\r\n            $('#' + this.options.cancelUploadsId, this.el).click(function(){\r\n                while (self.files.length) {\r\n                    self.files.at(0).cancel();\r\n                }\r\n            });\r\n\r\n            // Add start uploads handler\r\n            $('#' + this.options.startUploadsId, this.el).click(function(){\r\n                self.files.each(function(file){\r\n                    file.start();\r\n                });\r\n            });\r\n\r\n            // Render current files\r\n            $.each(this.files, function (i, file) {\r\n                self.renderFile(file);\r\n            });\r\n        }\r\n    }, {\r\n        /**\r\n         * This model represents a file.\r\n         *\r\n         */\r\n        File: Backbone.Model.extend({\r\n            state: \"pending\",\r\n\r\n            /**\r\n             * Start upload.\r\n             *\r\n             */\r\n            start: function ()\r\n            {\r\n                if (this.isPending()) {\r\n                    this.get('processor').submit();\r\n                    this.state = \"running\";\r\n\r\n                    // Dispatch event\r\n                    this.trigger('filestarted', this);\r\n                }\r\n            },\r\n\r\n            /**\r\n             * Cancel a file upload.\r\n             *\r\n             */\r\n            cancel: function ()\r\n            {\r\n                this.get('processor').abort();\r\n                this.destroy();\r\n\r\n                // Dispatch event\r\n                this.state = \"canceled\";\r\n                this.trigger('filecanceled', this);\r\n            },\r\n\r\n            /**\r\n             * Notify file that progress updated.\r\n             *\r\n             */\r\n            progress: function (data)\r\n            {\r\n                // Dispatch event\r\n                this.trigger('fileprogress', this.get('processor').progress());\r\n            },\r\n\r\n            /**\r\n             * Notify file that upload failed.\r\n             *\r\n             */\r\n            fail: function (error)\r\n            {\r\n                // Dispatch event\r\n                this.state = \"error\";\r\n                this.trigger('filefailed', error);\r\n            },\r\n\r\n            /**\r\n             * Notify file that upload is done.\r\n             *\r\n             */\r\n            done: function (result)\r\n            {\r\n                // Dispatch event\r\n                this.state = \"error\";\r\n                this.trigger('filedone', result);\r\n            },\r\n\r\n            /**\r\n             * Is this file pending to be uploaded ?\r\n             *\r\n             */\r\n            isPending: function ()\r\n            {\r\n                return this.getState() == \"pending\";\r\n            },\r\n\r\n            /**\r\n             * Is this file currently uploading ?\r\n             *\r\n             */\r\n            isRunning: function ()\r\n            {\r\n                return this.getState() == \"running\";\r\n            },\r\n\r\n            /**\r\n             * Is this file uploaded ?\r\n             *\r\n             */\r\n            isDone: function ()\r\n            {\r\n                return this.getState() == \"done\";\r\n            },\r\n\r\n            /**\r\n             * Is this upload in error ?\r\n             *\r\n             */\r\n            isError: function ()\r\n            {\r\n                return this.getState() == \"error\" || this.getState == \"canceled\";\r\n            },\r\n\r\n            /**\r\n             * Get the file state.\r\n             *\r\n             */\r\n            getState: function ()\r\n            {\r\n                return this.state;\r\n            }\r\n        }),\r\n\r\n        /**\r\n         * This is a file collection, used to manage the selected\r\n         * and processing files.\r\n         *\r\n         */\r\n        FileCollection: Backbone.Collection.extend({\r\n            model: this.File\r\n        }),\r\n\r\n        /**\r\n         * A file view, which is the view that manage a single file\r\n         * process in the upload manager.\r\n         *\r\n         */\r\n        FileView: Backbone.DeferedView.extend({\r\n            className: 'upload-manager-file row',\r\n\r\n            initialize: function (options) {\r\n                this.templateName = options.templates.file;\r\n                this.processUploadMsg = options.processUploadMsg;\r\n                this.doneMsg = options.doneMsg;\r\n\r\n                // Bind model events\r\n                this.model.on('destroy', this.close, this);\r\n                this.model.on('fileprogress', this.updateProgress, this);\r\n                this.model.on('filefailed', this.hasFailed, this);\r\n                this.model.on('filedone', this.hasDone, this);\r\n\r\n                // In each case, update view\r\n                this.model.on('all', this.update, this);\r\n            },\r\n\r\n            /**\r\n             * Render the file item view.\r\n             *\r\n             */\r\n            render: function ()\r\n            {\r\n                $(this.el).html(this.template(this.computeData()));\r\n\r\n                // Bind events\r\n                this.bindEvents();\r\n\r\n                // Update elements\r\n                this.update();\r\n            },\r\n\r\n            /**\r\n             * Update upload progress.\r\n             *\r\n             */\r\n            updateProgress: function (progress)\r\n            {\r\n                var percent = parseInt(progress.loaded / progress.total * 100, 10);\r\n                var progressHTML = this.getHelpers().displaySize(progress.loaded)+' of '+this.getHelpers().displaySize(progress.total);\r\n                if (percent >= 100 && this.processUploadMsg) { progressHTML = this.processUploadMsg; }\r\n\r\n                $('.progress', this.el)\r\n                    .find('.bar')\r\n                    .css('width', percent+'%')\r\n                    .parent()\r\n                    .find('.progress-label')\r\n                    .html(progressHTML);\r\n            },\r\n\r\n            /**\r\n             * File upload has failed.\r\n             *\r\n             */\r\n            hasFailed: function (error)\r\n            {\r\n                $('.message', this.el).html('<i class=\"icon-error\"></i> '+error);\r\n            },\r\n\r\n            /**\r\n             * File upload is done.\r\n             *\r\n             */\r\n            hasDone: function (result)\r\n            {\r\n                $('.message', this.el).html('<i class=\"icon-success\"></i> ' + (this.doneMsg || 'Uploaded'));\r\n            },\r\n\r\n            /**\r\n             * Update view without complete rendering.\r\n             *\r\n             */\r\n            update: function ()\r\n            {\r\n                var when_pending = $('.size, #btn-cancel', this.el),\r\n                    when_running = $('.progress, #btn-cancel', this.el),\r\n                    when_done = $('.message, #btn-clear', this.el);\r\n\r\n                if (this.model.isPending()) {\r\n                    when_running.add(when_done).addClass('hidden');\r\n                    when_pending.removeClass('hidden');\r\n                } else if (this.model.isRunning()) {\r\n                    when_pending.add(when_done).addClass('hidden');\r\n                    when_running.removeClass('hidden');\r\n                } else if (this.model.isDone() || this.model.isError()) {\r\n                    when_pending.add(when_running).addClass('hidden');\r\n                    when_done.removeClass('hidden');\r\n                }\r\n            },\r\n\r\n            /**\r\n             * Bind local elements events.\r\n             *\r\n             */\r\n            bindEvents: function ()\r\n            {\r\n                var self = this;\r\n\r\n                // DOM events\r\n                $('#btn-cancel', this.el).click(function(){\r\n                    self.model.cancel();\r\n                    self.collection.remove(self.model);\r\n                });\r\n                $('#btn-clear', this.el).click(function(){\r\n                    self.model.destroy();\r\n                    self.collection.remove(self.model);\r\n                });\r\n            },\r\n\r\n            /**\r\n             * Compute data to be passed to the view.\r\n             *\r\n             */\r\n            computeData: function ()\r\n            {\r\n                return $.extend(this.getHelpers(), this.model.get('data'));\r\n            }\r\n        })\r\n    });\r\n});\r\n\ndefine('skylark-backbone-uploader/main',[\r\n\t\"skylark-backbone\",\r\n\t\"./defered-view-loader\",\r\n\t\"./upload-manager\"\r\n],function(Backbone){\r\n\treturn Backbone\r\n});\ndefine('skylark-backbone-uploader', ['skylark-backbone-uploader/main'], function (main) { return main; });\n\n"]}