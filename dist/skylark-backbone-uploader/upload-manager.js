/**
 * skylark-backbone-uploader - The backbone file upload manager use skylark-backbone
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["skylark-utils-filer/uploader","skylark-backbone","./defered-view-loader"],function(e,t){t.UploadManager=t.DeferedView.extend({defaults:{templates:{main:"/templates/upload-manager.main.default",file:"/templates/upload-manager.file.default"},uploadUrl:"/upload",autoUpload:!1,fileUploadId:"fileupload",startUploadsId:"start-uploads-button",cancelUploadsId:"cancel-uploads-button",dataType:"json"},file_id:0,className:"upload-manager",initialize:function(e){this.options=$.extend(this.defaults,e),this.templateName=this.options.templates.main,this.files=new t.UploadManager.FileCollection,this.bindLocal()},bindLocal:function(){var e=this;this.on("fileadd",function(t){e.files.add(t),e.renderFile(t)}).on("fileprogress",function(e,t){e.progress(t)}).on("filefail",function(e,t){e.fail(t)}).on("filedone",function(e,t){e.done(t.result)}),this.files.on("all",this.update,this)},renderFile:function(e){var i=new t.UploadManager.FileView($.extend(this.options,{model:e}));$("#file-list",self.el).append(i.deferedRender().el)},update:function(){var e=$("#"+this.options.cancelUploadsId+", #"+this.options.startUploadsId,this.el),t=$("#file-list .no-data",this.el);this.files.length>0?(e.removeClass("hidden"),t.addClass("hidden")):(e.addClass("hidden"),t.removeClass("hidden"))},bindProcessEvents:function(){},render:function(){$(this.el).html(this.template()),this.update();var i=$(".fileinput-button",this.el),s=this;this.uploadProcess=e(this.el,{dataType:this.options.dataType,url:this.options.uploadUrl,formData:this.options.formData,autoUpload:this.options.autoUpload,singleFileUploads:!0,picker:i,add:function(e,i){i.uploadManagerFiles=[],$.each(i.files,function(e,n){n.id=s.file_id++;var o=new t.UploadManager.File({data:n,processor:i});i.uploadManagerFiles.push(o),s.trigger("fileadd",o)})},progress:function(e,t){$.each(t.uploadManagerFiles,function(e,i){s.trigger("fileprogress",i,t)})},fail:function(e,t){$.each(t.uploadManagerFiles,function(e,i){var n="Unknown error";"string"==typeof t.errorThrown?n=t.errorThrown:"object"==typeof t.errorThrown?n=t.errorThrown.message:t.result&&(n=t.result.error?t.result.error:t.result.files&&t.result.files[e]&&t.result.files[e].error?t.result.files[e].error:"Unknown remote error"),s.trigger("filefail",i,n)})},done:function(e,t){$.each(t.uploadManagerFiles,function(e,i){s.trigger("filedone",i,t)})}}),this.bindProcessEvents(),$("#"+this.options.cancelUploadsId,this.el).click(function(){for(;s.files.length;)s.files.at(0).cancel()}),$("#"+this.options.startUploadsId,this.el).click(function(){s.files.each(function(e){e.start()})}),$.each(this.files,function(e,t){s.renderFile(t)})}},{File:t.Model.extend({state:"pending",start:function(){this.isPending()&&(this.get("processor").submit(),this.state="running",this.trigger("filestarted",this))},cancel:function(){this.get("processor").abort(),this.destroy(),this.state="canceled",this.trigger("filecanceled",this)},progress:function(e){this.trigger("fileprogress",this.get("processor").progress())},fail:function(e){this.state="error",this.trigger("filefailed",e)},done:function(e){this.state="error",this.trigger("filedone",e)},isPending:function(){return"pending"==this.getState()},isRunning:function(){return"running"==this.getState()},isDone:function(){return"done"==this.getState()},isError:function(){return"error"==this.getState()||"canceled"==this.getState},getState:function(){return this.state}}),FileCollection:t.Collection.extend({model:this.File}),FileView:t.DeferedView.extend({className:"upload-manager-file row",initialize:function(e){this.templateName=e.templates.file,this.processUploadMsg=e.processUploadMsg,this.doneMsg=e.doneMsg,this.model.on("destroy",this.close,this),this.model.on("fileprogress",this.updateProgress,this),this.model.on("filefailed",this.hasFailed,this),this.model.on("filedone",this.hasDone,this),this.model.on("all",this.update,this)},render:function(){$(this.el).html(this.template(this.computeData())),this.bindEvents(),this.update()},updateProgress:function(e){var t=parseInt(e.loaded/e.total*100,10),i=this.getHelpers().displaySize(e.loaded)+" of "+this.getHelpers().displaySize(e.total);t>=100&&this.processUploadMsg&&(i=this.processUploadMsg),$(".progress",this.el).find(".bar").css("width",t+"%").parent().find(".progress-label").html(i)},hasFailed:function(e){$(".message",this.el).html('<i class="icon-error"></i> '+e)},hasDone:function(e){$(".message",this.el).html('<i class="icon-success"></i> '+(this.doneMsg||"Uploaded"))},update:function(){var e=$(".size, #btn-cancel",this.el),t=$(".progress, #btn-cancel",this.el),i=$(".message, #btn-clear",this.el);this.model.isPending()?(t.add(i).addClass("hidden"),e.removeClass("hidden")):this.model.isRunning()?(e.add(i).addClass("hidden"),t.removeClass("hidden")):(this.model.isDone()||this.model.isError())&&(e.add(t).addClass("hidden"),i.removeClass("hidden"))},bindEvents:function(){var e=this;$("#btn-cancel",this.el).click(function(){e.model.cancel(),e.collection.remove(e.model)}),$("#btn-clear",this.el).click(function(){e.model.destroy(),e.collection.remove(e.model)})},computeData:function(){return $.extend(this.getHelpers(),this.model.get("data"))}})})});
//# sourceMappingURL=sourcemaps/upload-manager.js.map
