/**
 * skylark-backbone-uploader - The backbone file upload manager use skylark-backbone
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
!function(e,t){var i=t.define,n=t.require,s="function"==typeof i&&i.amd,o=!s&&"undefined"!=typeof exports;if(!s&&!i){var a={};i=t.define=function(e,t,i){"function"==typeof i?(a[e]={factory:i,deps:t.map(function(t){return function(e,t){if("."!==e[0])return e;var i=t.split("/"),n=e.split("/");i.pop();for(var s=0;s<n.length;s++)"."!=n[s]&&(".."==n[s]?i.pop():i.push(n[s]));return i.join("/")}(t,e)}),resolved:!1,exports:null},n(e)):a[e]={factory:null,resolved:!0,exports:i}},n=t.require=function(e){if(!a.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var i=a[e];if(!i.resolved){var s=[];i.deps.forEach(function(e){s.push(n(e))}),i.exports=i.factory.apply(t,s)||null,i.resolved=!0}return i.exports}}if(!i)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,t){e("backbone-defered-view-loader",["skylark-backbone"],function(e){e.TemplateManager={templates:{},baseUrl:"/templates/{name}",loadings:new Array,currentViews:{},queues:{},set:function(e,t){this.templates[e]=t;var i=this.queues[e];if(i)for(var n=0;n<i.length;n++)i[n].dfd.resolveWith(i[n].context,[t]);this.queues[e]=new Array},notLoading:function(e){var t=this.loadings.indexOf(e);if(-1!=t){var i=this.loadings.slice(t+1||this.loadings.length);return this.loadings.length=t<0?this.loadings.length+t:t,this.loadings.push.apply(this,i)}},get:function(t,i){if(null==t)throw"Template name must be defined";var n=$.Deferred();if(this.templates[t])n.resolveWith(i,[this.templates[t]]);else if(this.queues[t]||(this.queues[t]=new Array),this.queues[t].push({dfd:n,context:i}),-1==this.loadings.indexOf(t)){this.loadings.push(t);var s=e.TemplateManager.baseUrl.replace("{name}",t);$.get(s,function(i){var n=_.template(i);e.TemplateManager.notLoading(t),e.TemplateManager.set(t,n)}).error(function(){e.TemplateManager.notLoading(t)})}return n.promise()}},e.DeferedView=e.View.extend({templateName:null,container:null,loadedCountDown:1,deferedRender:function(t){this.templateName,e.TemplateManager.get(this.templateName,this).then(function(e){this.template=e,this.render(),this.isLoaded(!0),void 0!=t&&"function"==typeof t&&t()});return this},getHelpers:function(){return{displaySize:function(e){if(0==e)return"0 B";var t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(e/Math.pow(1024,t)).toFixed(2)+" "+["B","KB","MB","GB","TB"][t]},displayDate:function(e){return new Date(e).toLocaleString()}}},renderTo:function(t,i){return e.TemplateManager.currentViews[t]&&e.TemplateManager.currentViews[t].close(),e.TemplateManager.currentViews[t]=this,this.isLoaded(!1),$(t).html(this.deferedRender(i).el),this},isLoaded:function(e){return void 0!=e&&(this.loadedCountDown+=e?-1:1,this.loadedCountDown>0?$(this.el).addClass("loading"):$(this.el).removeClass("loading")),0==this.loadedCountDown},close:function(){"function"==typeof this.onPreClose&&this.onPreClose(),this.remove(),this.unbind(),"function"==typeof this.onClose&&this.onClose()}})}),e("skylark-backbone-uploader/defered-view-loader",function(){}),e("skylark-backbone-uploader/upload-manager",["skylark-utils-filer/uploader","skylark-backbone","./defered-view-loader"],function(e,t){t.UploadManager=t.DeferedView.extend({defaults:{templates:{main:"/templates/upload-manager.main.default",file:"/templates/upload-manager.file.default"},uploadUrl:"/upload",autoUpload:!1,fileUploadId:"fileupload",startUploadsId:"start-uploads-button",cancelUploadsId:"cancel-uploads-button",dataType:"json"},file_id:0,className:"upload-manager",initialize:function(e){this.options=$.extend(this.defaults,e),this.templateName=this.options.templates.main,this.files=new t.UploadManager.FileCollection,this.bindLocal()},bindLocal:function(){var e=this;this.on("fileadd",function(t){e.files.add(t),e.renderFile(t)}).on("fileprogress",function(e,t){e.progress(t)}).on("filefail",function(e,t){e.fail(t)}).on("filedone",function(e,t){e.done(t.result)}),this.files.on("all",this.update,this)},renderFile:function(e){var i=new t.UploadManager.FileView($.extend(this.options,{model:e}));$("#file-list",self.el).append(i.deferedRender().el)},update:function(){var e=$("#"+this.options.cancelUploadsId+", #"+this.options.startUploadsId,this.el),t=$("#file-list .no-data",this.el);this.files.length>0?(e.removeClass("hidden"),t.addClass("hidden")):(e.addClass("hidden"),t.removeClass("hidden"))},bindProcessEvents:function(){},render:function(){var i=this;$(this.el).html(this.template()),this.update();var n=$(".fileinput-button",this.el),i=this;this.uploadProcess=e(this.el,{dataType:this.options.dataType,url:this.options.uploadUrl,formData:this.options.formData,autoUpload:this.options.autoUpload,singleFileUploads:!0,picker:n,add:function(e,n){n.uploadManagerFiles=[],$.each(n.files,function(e,s){s.id=i.file_id++;var o=new t.UploadManager.File({data:s,processor:n});n.uploadManagerFiles.push(o),i.trigger("fileadd",o)})},progress:function(e,t){$.each(t.uploadManagerFiles,function(e,n){i.trigger("fileprogress",n,t)})},fail:function(e,t){$.each(t.uploadManagerFiles,function(e,n){var s="Unknown error";"string"==typeof t.errorThrown?s=t.errorThrown:"object"==typeof t.errorThrown?s=t.errorThrown.message:t.result&&(s=t.result.error?t.result.error:t.result.files&&t.result.files[e]&&t.result.files[e].error?t.result.files[e].error:"Unknown remote error"),i.trigger("filefail",n,s)})},done:function(e,t){$.each(t.uploadManagerFiles,function(e,n){i.trigger("filedone",n,t)})}}),this.bindProcessEvents(),$("#"+this.options.cancelUploadsId,this.el).click(function(){for(;i.files.length;)i.files.at(0).cancel()}),$("#"+this.options.startUploadsId,this.el).click(function(){i.files.each(function(e){e.start()})}),$.each(this.files,function(e,t){i.renderFile(t)})}},{File:t.Model.extend({state:"pending",start:function(){this.isPending()&&(this.get("processor").submit(),this.state="running",this.trigger("filestarted",this))},cancel:function(){this.get("processor").abort(),this.destroy(),this.state="canceled",this.trigger("filecanceled",this)},progress:function(e){this.trigger("fileprogress",this.get("processor").progress())},fail:function(e){this.state="error",this.trigger("filefailed",e)},done:function(e){this.state="error",this.trigger("filedone",e)},isPending:function(){return"pending"==this.getState()},isRunning:function(){return"running"==this.getState()},isDone:function(){return"done"==this.getState()},isError:function(){return"error"==this.getState()||"canceled"==this.getState},getState:function(){return this.state}}),FileCollection:t.Collection.extend({model:this.File}),FileView:t.DeferedView.extend({className:"upload-manager-file row",initialize:function(e){this.templateName=e.templates.file,this.processUploadMsg=e.processUploadMsg,this.doneMsg=e.doneMsg,this.model.on("destroy",this.close,this),this.model.on("fileprogress",this.updateProgress,this),this.model.on("filefailed",this.hasFailed,this),this.model.on("filedone",this.hasDone,this),this.model.on("all",this.update,this)},render:function(){$(this.el).html(this.template(this.computeData())),this.bindEvents(),this.update()},updateProgress:function(e){var t=parseInt(e.loaded/e.total*100,10),i=this.getHelpers().displaySize(e.loaded)+" of "+this.getHelpers().displaySize(e.total);t>=100&&this.processUploadMsg&&(i=this.processUploadMsg),$(".progress",this.el).find(".bar").css("width",t+"%").parent().find(".progress-label").html(i)},hasFailed:function(e){$(".message",this.el).html('<i class="icon-error"></i> '+e)},hasDone:function(e){$(".message",this.el).html('<i class="icon-success"></i> '+(this.doneMsg||"Uploaded"))},update:function(){var e=$(".size, #btn-cancel",this.el),t=$(".progress, #btn-cancel",this.el),i=$(".message, #btn-clear",this.el);this.model.isPending()?(t.add(i).addClass("hidden"),e.removeClass("hidden")):this.model.isRunning()?(e.add(i).addClass("hidden"),t.removeClass("hidden")):(this.model.isDone()||this.model.isError())&&(e.add(t).addClass("hidden"),i.removeClass("hidden"))},bindEvents:function(){var e=this;$("#btn-cancel",this.el).click(function(){e.model.cancel(),e.collection.remove(e.model)}),$("#btn-clear",this.el).click(function(){e.model.destroy(),e.collection.remove(e.model)})},computeData:function(){return $.extend(this.getHelpers(),this.model.get("data"))}})})}),e("skylark-backbone-uploader/main",["skylark-backbone","./defered-view-loader","./upload-manager"],function(e){return e}),e("skylark-backbone-uploader",["skylark-backbone-uploader/main"],function(e){return e})}(i),!s){var r=n("skylark-langx/skylark");o?module.exports=r:t.skylarkjs=r}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-backbone-uploader.js.map
