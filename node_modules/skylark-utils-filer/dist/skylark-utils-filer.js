/**
 * skylark-utils-filer - The filer features enhancement for skylark utils.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.1
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(e,t){var r=t.define,i=t.require,n="function"==typeof r&&r.amd,s=!n&&"undefined"!=typeof exports;if(!n&&!r){var o={};r=t.define=function(e,t,r){"function"==typeof r?(o[e]={factory:r,deps:t.map(function(t){return function(e,t){if("."!==e[0])return e;var r=t.split("/"),i=e.split("/");r.pop();for(var n=0;n<i.length;n++)"."!=i[n]&&(".."==i[n]?r.pop():r.push(i[n]));return r.join("/")}(t,e)}),resolved:!1,exports:null},i(e)):o[e]={factory:null,resolved:!0,exports:r}},i=t.require=function(e){if(!o.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var r=o[e];if(!r.resolved){var n=[];r.deps.forEach(function(e){n.push(i(e))}),r.exports=r.factory.apply(t,n)||null,r.resolved=!0}return r.exports}}if(!r)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,t){e("skylark-utils-filer/filer",["skylark-langx/skylark"],function(e){var t=function(){return t};return e.filer=t}),e("skylark-utils-filer/download",["./filer"],function(e){return e.downlad=function(e,t){if(window.navigator.msSaveBlob)types.isString(e)&&(e=dataURItoBlob(e)),window.navigator.msSaveBlob(e,t);else{var r=document.createElement("a");e instanceof Blob&&(e=URL.createObjectURL(e)),r.href=e,r.setAttribute("download",t||"noname"),r.dispatchEvent(new CustomEvent("click"))}}}),e("skylark-utils-filer/webentry",["skylark-langx/arrays","skylark-langx/Deferred","./filer"],function(e,t,r){var i=Array.prototype.concat,n=function(){function r(e,r){var i=new t,s=function(e){i.reject(e)};if(r=r||"",e.isFile)e.file(function(e){e.relativePath=r,i.resolve(e)},s);else if(e.isDirectory){var o=e.createReader();o.readEntries(function(t){n(t,r+e.name+"/").then(function(e){i.resolve(e)}).catch(s)},s)}else i.resolve([]);return i.promise}function n(n,s){return t.all(e.map(n,function(e){return r(e,s)})).then(function(){return i.apply([],arguments)})}return{one:r,all:n}}();return r.webentry=n}),e("skylark-utils-filer/dropzone",["skylark-langx/arrays","skylark-langx/Deferred","skylark-utils-dom/styler","skylark-utils-dom/eventer","./filer","./webentry"],function(e,t,r,i,n,s){return n.dropzone=function(t,n){var o=(n=n||{}).hoverClass||"dropzone",a=n.dropped,l=0;return i.on(t,"dragenter",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&(i.stop(e),l++,r.addClass(t,o))}),i.on(t,"dragover",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&i.stop(e)}),i.on(t,"dragleave",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&0==--l&&r.removeClass(t,o)}),i.on(t,"drop",function(n){if(n.dataTransfer&&n.dataTransfer.types.indexOf("Files")>-1&&(r.removeClass(t,o),i.stop(n),a)){var l=n.dataTransfer.items;l&&l.length&&(l[0].webkitGetAsEntry||l[0].getAsEntry)?s.all(e.map(l,function(e){return e.webkitGetAsEntry?e.webkitGetAsEntry():e.getAsEntry()})).then(a):a(n.dataTransfer.files)}}),this}}),e("skylark-utils-filer/pastezone",["skylark-langx/objects","skylark-utils-dom/eventer","./filer"],function(e,t,r){return r.pastezone=function(r,i){(i=i||{}).hoverClass;var n=i.pasted;return t.on(r,"paste",function(t){var r=t.originalEvent&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items,i=[];r&&r.length&&e.each(r,function(e,t){var r=t.getAsFile&&t.getAsFile();r&&i.push(r)}),n&&i.length&&n(i)}),this}}),e("skylark-utils-filer/select",["./filer"],function(e){var t,r=1/0;return e.select=function(e){var i=(e=e||{}).directory||!1,n=e.multiple||!1,s=e.picked;if(!t){var o=t=document.createElement("input");function a(e){for(var t=e.length;t--;)e[t].size>r&&e.splice(t,1);s(e)}o.type="file",o.style.position="fixed",o.style.left=0,o.style.top=0,o.style.opacity=.001,document.body.appendChild(o),o.onchange=function(e){var t=e.target.webkitEntries||e.target.entries;t&&t.length?webentry.all(t).then(function(e){a(e)}):a(Array.prototype.slice.call(e.target.files)),o.value=""}}t.multiple=n,t.webkitdirectory=i,t.click()}}),e("skylark-utils-filer/picker",["skylark-langx/objects","skylark-utils-dom/eventer","./filer","./select"],function(e,t,r,i){return r.picker=function(e,r){return t.on(e,"click",function(e){e.preventDefault(),i(r)}),this}}),e("skylark-utils-filer/read",["skylark-langx/Deferred","./filer"],function(e,t){return t.read=t.readFile=function(t,r){r=r||{};var i=new e,n=new FileReader;n.onload=function(e){i.resolve(e.target.result)},n.onerror=function(e){var t=e.target.error.code;2===t?alert("please don't open this page using protocol fill:///"):alert("error code: "+t)},r.asArrayBuffer?n.readAsArrayBuffer(t):r.asDataUrl?n.readAsDataURL(t):r.asText?n.readAsText(t):n.readAsArrayBuffer(t);return i.promise}}),e("skylark-utils-filer/upload",["skylark-langx/types","skylark-langx/objects","skylark-langx/arrays","skylark-langx/Deferred","skylark-langx/Xhr","./filer"],function(e,t,r,i,n,s){return s.upload=function(r){var s=t.mixin({contentRange:null,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,limitMultiFileUploadSize:void 0,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!0,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(e,r){return e=this.messages[e]||e.toString(),r&&t.each(r,function(t,r){e=e.replace("{"+t+"}",r)}),e},formData:function(e){return e.serializeArray()},add:function(e,t){if(e.isDefaultPrevented())return!1;(t.autoUpload||!1!==t.autoUpload&&$(this).fileupload("option","autoUpload"))&&t.process().done(function(){t.submit()})},processData:!1,contentType:!1,cache:!1},r),o=function(){var e=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice;return e.apply(this,arguments)},a=function(e){return n.request(e.url,e)};function l(r){var i,n=r.files[0],s=r.multipart,o="array"===e.type(r.paramName)?r.paramName[0]:r.paramName;r.headers=t.mixin({},r.headers),r.contentRange&&(r.headers["Content-Range"]=r.contentRange),s?(i=new FormData,r.blob?i.append(o,r.blob,n.name):t.each(r.files,function(t,n){i.append("array"===e.type(r.paramName)&&r.paramName[t]||o,n,n.uploadName||n.name)}),r.data=i):(r.headers["Content-Disposition"]='attachment; filename="'+encodeURI(n.name)+'"',r.contentType=n.type||"application/octet-stream",r.data=r.blob||n),r.blob=null}function u(e,r){e.uploadedBytes=e.uploadedBytes||0;var n,s,u=e.files[0],d=u.size,p=e.uploadedBytes,c=e.maxChunkSize||d,f=o,h=new i,g=h.promise;return!(!f||!(p||c<d)||e.data)&&(!!r||(p>=d?(u.error=e.i18n("uploadedBytes"),this._getXHRPromise(!1,e.context,[null,"error",u.error])):(s=function(){var r=t.mixin({},e),i=r._progress.loaded;r.blob=f.call(u,p,p+c,u.type),r.chunkSize=r.blob.size,r.contentRange="bytes "+p+"-"+(p+r.chunkSize-1)+"/"+d,l(r),n=a(r).done(function(t,n,o){p=function(e){var t=e.getResponseHeader("Range"),r=t&&t.split("-"),i=r&&r.length>1&&parseInt(r[1],10);return i&&i+1}(o)||p+r.chunkSize,i+r.chunkSize-r._progress.loaded&&h.progress({lengthComputable:!0,loaded:p-r.uploadedBytes,total:p-r.uploadedBytes}),e.uploadedBytes=r.uploadedBytes=p,r.result=t,r.textStatus=n,r.jqXHR=o,p<d?s():h.resolveWith(r.context,[t,n,o])}).fail(function(e,t,i){r.jqXHR=e,r.textStatus=t,r.errorThrown=i,h.rejectWith(r.context,[e,t,i])})},g.abort=function(){return n.abort()},s(),g)))}d=s,d.type=d.type||"POST",u(d,!0)||d.data||l(d),s._bitrateTimer=new function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,r){var i=e-this.timestamp;return(!this.bitrate||!r||i>r)&&(this.bitrate=(t-this.loaded)*(1e3/i)*8,this.loaded=t,this.timestamp=e),this.bitrate}};var d;var p=u(s)||a(s);return p.options=s,p}}),e("skylark-utils-filer/uploader",["skylark-langx/langx","skylark-utils-dom/eventer","skylark-utils-dom/query","./filer","./dropzone","./pastezone","./picker","./upload"],function(e,t,r,i,n,s,o,a){"use strict";var l=e.Deferred,u=e.Evented.inherit({options:{dropZone:r(document),pasteZone:r(document),picker:void 0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,limitMultiFileUploadSize:void 0,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!1,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(t,r){return t=this.messages[t]||t.toString(),r&&e.each(r,function(e,r){t=t.replace("{"+e+"}",r)}),t},formData:function(e){return e.serializeArray()},add:function(e,t){if(e.isDefaultPrevented())return!1;(t.autoUpload||!1!==t.autoUpload&&r(this).fileupload("instance").option("autoUpload"))&&t.process().done(function(){t.submit()})},processData:!1,contentType:!1,cache:!1},_specialOptions:["picker","dropZone","pasteZone","multipart","filesContainer","uploadTemplateId","downloadTemplateId"],_BitrateTimer:function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,r){var i=e-this.timestamp;return(!this.bitrate||!r||i>r)&&(this.bitrate=(t-this.loaded)*(1e3/i)*8,this.loaded=t,this.timestamp=e),this.bitrate}},_getTotal:function(t){var r=0;return e.each(t,function(e,t){r+=t.size||1}),r},_initProgressObject:function(t){var r={loaded:0,total:0,bitrate:0};t._progress?e.extend(t._progress,r):t._progress=r},_initResponseObject:function(e){var t;if(e._response)for(t in e._response)e._response.hasOwnProperty(t)&&delete e._response[t];else e._response={}},_onProgress:function(e,r){if(e.lengthComputable){var i,n=Date.now?Date.now():(new Date).getTime();if(r._time&&r.progressInterval&&n-r._time<r.progressInterval&&e.loaded!==e.total)return;r._time=n,i=Math.floor(e.loaded/e.total*(r.chunkSize||r._progress.total))+(r.uploadedBytes||0),this._progress.loaded+=i-r._progress.loaded,this._progress.bitrate=this._bitrateTimer.getBitrate(n,this._progress.loaded,r.bitrateInterval),r._progress.loaded=r.loaded=i,r._progress.bitrate=r.bitrate=r._bitrateTimer.getBitrate(n,i,r.bitrateInterval),this._trigger("progress",t.create("progress",{delegatedEvent:e}),r),this._trigger("progressall",t.create("progressall",{delegatedEvent:e}),this._progress)}},_getParamName:function(t){r(t.picker);var i=t.paramName;return e.isArray(i)||(i=[i]),i},_getDeferredState:function(e){return e.state?e.state():e.isResolved()?"resolved":e.isRejected()?"rejected":"pending"},_enhancePromise:function(e){return e.success=e.done,e.error=e.fail,e.complete=e.always,e},_getXHRPromise:function(e,t,r){var i=new l,n=i.promise;return t=t||this.options.context||n,!0===e?i.resolveWith(t,r):!1===e&&i.rejectWith(t,r),n.abort=i.promise,this._enhancePromise(n)},_addConvenienceMethods:function(e,r){var i=this,n=function(e){return(new l).resolveWith(i,e).promise};r.process=function(e,t){return(e||t)&&(r._processQueue=this._processQueue=(this._processQueue||n([this])).pipe(function(){return r.errorThrown?(new l).rejectWith(i,[r]).promise:n(arguments)}).pipe(e,t)),this._processQueue||n([this])},r.submit=function(){return"pending"!==this.state()&&(r.jqXHR=this.jqXHR=!1!==i._trigger("submit",t.create("submit",{delegatedEvent:e}),this)&&i._onSend(e,this)),this.jqXHR||i._getXHRPromise()},r.abort=function(){return this.jqXHR?this.jqXHR.abort():(this.errorThrown="abort",i._trigger("fail",null,this),i._getXHRPromise(!1))},r.state=function(){return this.jqXHR?i._getDeferredState(this.jqXHR):this._processQueue?i._getDeferredState(this._processQueue):void 0},r.processing=function(){return!this.jqXHR&&this._processQueue&&"pending"===i._getDeferredState(this._processQueue)},r.progress=function(){return this._progress},r.response=function(){return this._response}},_beforeSend:function(e,t){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer,this._progress.loaded=this._progress.total=0,this._progress.bitrate=0),this._initResponseObject(t),this._initProgressObject(t),t._progress.loaded=t.loaded=t.uploadedBytes||0,t._progress.total=t.total=this._getTotal(t.files)||1,t._progress.bitrate=t.bitrate=0,this._active+=1,this._progress.loaded+=t.loaded,this._progress.total+=t.total},_onDone:function(e,r,i,n){var s=n._progress.total,o=n._response;n._progress.loaded<s&&this._onProgress(t.create("progress",{lengthComputable:!0,loaded:s,total:s}),n),o.result=n.result=e,o.textStatus=n.textStatus=r,o.jqXHR=n.jqXHR=i,this._trigger("done",null,n)},_onFail:function(e,t,r,i){var n=i._response;i.recalculateProgress&&(this._progress.loaded-=i._progress.loaded,this._progress.total-=i._progress.total),n.jqXHR=i.jqXHR=e,n.textStatus=i.textStatus=t,n.errorThrown=i.errorThrown=r,this._trigger("fail",null,i)},_trigger:function(e,r,i){var n=t.proxy(r);return n.type=e,n.data=i,this.trigger(n,i)},_onAlways:function(e,t,r,i){this._trigger("always",null,i)},_onSend:function(e,t){t.submit||this._addConvenienceMethods(e,t);var r,i=this;return this._beforeSend(e,t),i._sending+=1,t.url=i.options.url,t.dataType=i.options.dataType,t.xhrFields=i.options.xhrFields,(r=a(t)).progress(function(e){i._onProgress(e,r.options)}).done(function(e,t){i._onDone(e,t,r,r.options)}).fail(function(e,t){i._onFail(r,t,e,r.options)}).always(function(){i._sending-=1,i._active-=1,i._trigger("stop")}),r},_onAdd:function(r,i){var n,s,o,a,l=this,u=!0,d=e.extend({},this.options,i),p=i.files,c=p.length,f=d.limitMultiFileUploads,h=d.limitMultiFileUploadSize,g=d.limitMultiFileUploadSizeOverhead,m=0,v=this._getParamName(d),_=0;if(!h||c&&void 0!==p[0].size||(h=void 0),d.singleFileUploads||f||h)if(d.singleFileUploads||h||!f)if(!d.singleFileUploads&&h)for(o=[],n=[],a=0;a<c;a+=1)m+=p[a].size+g,(a+1===c||m+p[a+1].size+g>h||f&&a+1-_>=f)&&(o.push(p.slice(_,a+1)),(s=v.slice(_,a+1)).length||(s=v),n.push(s),_=a+1,m=0);else n=v;else for(o=[],n=[],a=0;a<c;a+=f)o.push(p.slice(a,a+f)),(s=v.slice(a,a+f)).length||(s=v),n.push(s);else o=[p],n=[v];return i.originalFiles=p,e.each(o||p,function(s,a){var d=e.extend({},i);return d.files=o?a:[a],d.paramName=n[s],l._initResponseObject(d),l._initProgressObject(d),l._addConvenienceMethods(r,d),u=l._trigger("add",t.create("add",{delegatedEvent:r}),d)}),u},_initEventHandlers:function(){var e=this;n(this.options.dropZone[0],{dropped:function(t){var r={};r.files=t,e._onAdd(null,r)}}),s(this.options.pasteZone[0],{pasted:function(t){var r={};r.files=t,e._onAdd(null,r)}}),o(this.options.picker[0],{multiple:!0,picked:function(t){var r={};r.files=t,e._onAdd(null,r)}})},_destroyEventHandlers:function(){},_setOption:function(t,r){var i=-1!==e.inArray(t,this._specialOptions);i&&this._destroyEventHandlers(),this._super(t,r),i&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var e=this.options;e.picker&&(e.picker instanceof r||(e.picker=r(e.picker,this._elm))),e.dropZone&&(e.dropZone instanceof r||(e.dropZone=r(e.dropZone,this._elm))),e.pasteZone&&(e.pasteZone instanceof r||(e.pasteZone=r(e.pasteZone,this._elm)))},_getRegExp:function(e){var t=e.split("/"),r=t.pop();return t.shift(),new RegExp(t.join("/"),r)},_isRegExpOption:function(t,r){return"url"!==t&&"string"===e.type(r)&&/^\/.*\/[igm]{0,3}$/.test(r)},_construct:function(t,r){this._elm=t,this.options=e.mixin({},this.options,r),this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=0,this._initProgressObject(this),this._initEventHandlers()},active:function(){return this._active},progress:function(){return this._progress},add:function(t){t&&!this.options.disabled&&(t.files=e.makeArray(t.files),this._onAdd(null,t))},send:function(t){return t&&!this.options.disabled&&(t.files=e.makeArray(t.files),t.files.length)?this._onSend(null,t):this._getXHRPromise(!1,t&&t.context)}});return i.uploader=function(t,r){var i=new u(t,r);return i.on("all",function(t,n){var s=t.type;e.isFunction(r[s])&&r[s].call(i._elm,t,n)}),i}}),e("skylark-utils-filer/main",["./filer","./download","./dropzone","./pastezone","./picker","./read","./select","./upload","./uploader","./webentry"],function(e){return e}),e("skylark-utils-filer",["skylark-utils-filer/main"],function(e){return e})}(r),!n){var a=i("skylark-langx/skylark");s?module.exports=a:t.skylarkjs=a}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-utils-filer.js.map
