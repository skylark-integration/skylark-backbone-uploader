/**
 * skylark-fw-model - The skylark model layer framework library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(t,e){var i=e.define,r=e.require,n="function"==typeof i&&i.amd,s=!n&&"undefined"!=typeof exports;if(!n&&!i){var a={};i=e.define=function(t,e,i){"function"==typeof i?(a[t]={factory:i,deps:e.map(function(e){return function(t,e){if("."!==t[0])return t;var i=e.split("/"),r=t.split("/");i.pop();for(var n=0;n<r.length;n++)"."!=r[n]&&(".."==r[n]?i.pop():i.push(r[n]));return i.join("/")}(e,t)}),exports:null},r(t)):a[t]=i},r=e.require=function(t){if(!a.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var i=a[t];if(!i.exports){var n=[];i.deps.forEach(function(t){n.push(r(t))}),i.exports=i.factory.apply(e,n)}return i.exports}}if(!i)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(t,e){t("skylark-fw-model/models",["skylark-langx/langx"],function(t){function e(){return e}return t.mixin(e,{emulateHTTP:!1,emulateJSON:!1,backends:{}}),e}),t("skylark-fw-model/Entity",["skylark-langx/langx","./models"],function(t,e){var i=function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}},r=t.Stateful.inherit({sync:function(){return e.sync.apply(this,arguments)},matches:function(e){return t.isMatch(this.attributes,e)},fetch:function(e){var r=this,n=(e=t.mixin({parse:!0},e)).success;return e.success=function(t){var i=e.parse?r.parse(t,e):t;if(!r.set(i,e))return!1;n&&n.call(e.context,r,t,e),r.trigger("sync",r,t,e)},i(this,e),this.sync("read",this,e)},save:function(e,r,n){var s;null==e||"object"==typeof e?(s=e,n=r):(s={})[e]=r;var a=(n=t.mixin({validate:!0,parse:!0},n)).wait;if(s&&!a){if(!this.set(s,n))return!1}else if(!this._validate(s,n))return!1;var o=this,c=n.success,l=this.attributes;n.success=function(e){o.attributes=l;var i=n.parse?o.parse(e,n):e;if(a&&(i=t.mixin({},s,i)),i&&!o.set(i,n))return!1;c&&c.call(n.context,o,e,n),o.trigger("sync",o,e,n)},i(this,n),s&&a&&(this.attributes=t.mixin({},l,s));var h=this.isNew()?"create":n.patch?"patch":"update";"patch"!==h||n.attrs||(n.attrs=s);var u=this.sync(h,this,n);return this.attributes=l,u},destroy:function(e){var r=this,n=(e=e?t.clone(e):{}).success,s=e.wait,a=function(){r.stopListening(),r.trigger("destroy",r,r.collection,e)};e.success=function(t){s&&a(),n&&n.call(e.context,r,t,e),r.isNew()||r.trigger("sync",r,t,e)};var o=!1;return this.isNew()?t.defer(e.success):(i(this,e),o=this.sync("delete",this,e)),s||a(),o},url:function(){var e=t.result(this,"urlRoot")||t.result(this.collection,"url")||urlError();if(this.isNew())return e;var i=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(i)},parse:function(t,e){return t}});return e.Entity=r}),t("skylark-fw-model/Collection",["skylark-langx/langx","./models","./Entity"],function(t,e,i){var r=t.Evented.inherit({_construct:function(e,i){i||(i={}),i.entity&&(this.entity=i.entity),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),e&&this.reset(e,t.mixin({silent:!0},i))}}),n={add:!0,remove:!0,merge:!0},s={add:!0,remove:!1},a=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var r,n=Array(t.length-i),s=e.length;for(r=0;r<n.length;r++)n[r]=t[r+i];for(r=0;r<s;r++)t[r+i]=e[r];for(r=0;r<n.length;r++)t[r+s+i]=n[r]};return r.partial({entity:i,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(e,i){return this.set(e,t.mixin({merge:!1},i,s))},remove:function(e,i){i=t.mixin({},i);var r=!t.isArray(e);e=r?[e]:e.slice();var n=this._removeEntitys(e,i);return!i.silent&&n.length&&(i.changes={added:[],merged:[],removed:n},this.trigger("update",this,i)),r?n[0]:n},set:function(e,i){if(null!=e){(i=t.mixin({},n,i)).parse&&!this._isEntity(e)&&(e=this.parse(e,i)||[]);var r=!t.isArray(e);e=r?[e]:e.slice();var s=i.at;null!=s&&(s=+s),s>this.length&&(s=this.length),s<0&&(s+=this.length+1);var o,c,l=[],h=[],u=[],d=[],f={},g=i.add,y=i.merge,p=i.remove,m=!1,v=this.comparator&&null==s&&!1!==i.sort,k=t.isString(this.comparator)?this.comparator:null;for(c=0;c<e.length;c++){o=e[c];var x=this.get(o);if(x){if(y&&o!==x){var b=this._isEntity(o)?o.attributes:o;i.parse&&(b=x.parse(b,i)),x.set(b,i),u.push(x),v&&!m&&(m=x.hasChanged(k))}f[x.cid]||(f[x.cid]=!0,l.push(x)),e[c]=x}else g&&(o=e[c]=this._prepareEntity(o,i))&&(h.push(o),this._addReference(o,i),f[o.cid]=!0,l.push(o))}if(p){for(c=0;c<this.length;c++)o=this.entities[c],f[o.cid]||d.push(o);d.length&&this._removeEntitys(d,i)}var E=!1,S=!v&&g&&p;if(l.length&&S?(E=this.length!==l.length||this.entities.some(function(t,e){return t!==l[e]}),this.entities.length=0,a(this.entities,l,0),this.length=this.entities.length):h.length&&(v&&(m=!0),a(this.entities,h,null==s?this.length:s),this.length=this.entities.length),m&&this.sort({silent:!0}),!i.silent){for(c=0;c<h.length;c++)null!=s&&(i.index=s+c),(o=h[c]).trigger("add",o,this,i);(m||E)&&this.trigger("sort",this,i),(h.length||d.length||u.length)&&(i.changes={added:h,removed:d,merged:u},this.trigger("update",this,i))}return r?e[0]:e}},reset:function(e,i){i=i?t.clone(i):{};for(var r=0;r<this.entities.length;r++)this._removeReference(this.entities[r],i);return i.previousEntitys=this.entities,this._reset(),e=this.add(e,t.mixin({silent:!0},i)),i.silent||this.trigger("reset",this,i),e},push:function(e,i){return this.add(e,t.mixin({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(e,i){return this.add(e,t.mixin({at:0},i))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(e){var i=this.comparator;if(!i)throw new Error("Cannot sort a set without a comparator");e||(e={});var r=i.length;return t.isFunction(i)&&(i=t.proxy(i,this)),1===r||t.isString(i)?this.entities=this.sortBy(i):this.entities.sort(i),e.silent||this.trigger("sort",this,e),this},pluck:function(t){return this.map(t+"")},fetch:function(e){var i=(e=t.mixin({parse:!0},e)).success,r=this;return e.success=function(t){var n=e.reset?"reset":"set";r[n](t,e),i&&i.call(e.context,r,t,e),r.trigger("sync",r,t,e)},function(t,e){var i=e.error;e.error=function(r){i&&i.call(e.context,t,r,e),t.trigger("error",t,r,e)}}(this,e),this.sync("read",this,e)},create:function(e,i){var r=(i=i?t.clone(i):{}).wait;if(!(e=this._prepareEntity(e,i)))return!1;r||this.add(e,i);var n=this,s=i.success;return i.success=function(t,e,i){r&&n.add(t,i),s&&s.call(i.context,t,e,i)},e.save(null,i),e},parse:function(t,e){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(e,i){if(this._isEntity(e))return e.collection||(e.collection=this),e;(i=i?t.clone(i):{}).collection=this;var r=new this.entity(e,i);return r.validationError?(this.trigger("invalid",this,r.validationError,i),!1):r},_removeEntitys:function(t,e){for(var i=[],r=0;r<t.length;r++){var n=this.get(t[r]);if(n){var s=this.indexOf(n);this.entities.splice(s,1),this.length--,delete this._byId[n.cid];var a=this.entityId(n.attributes);null!=a&&delete this._byId[a],e.silent||(e.index=s,n.trigger("remove",n,this,e)),i.push(n),this._removeReference(n,e)}}return i},_isEntity:function(t){return t instanceof i},_addReference:function(t,e){this._byId[t.cid]=t;var i=this.entityId(t.attributes);null!=i&&(this._byId[i]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var i=this.entityId(t.attributes);null!=i&&delete this._byId[i],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,e,i,r){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,r),"change"===t){var n=this.entityId(e.previousAttributes()),s=this.entityId(e.attributes);n!==s&&(null!=n&&delete this._byId[n],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}),e.Collection=r}),t("skylark-fw-model/backends/registry",["skylark-langx/langx","../models"],function(t,e){var i={};return e.backends.registry={add:function(t,e){i[t]=e},remove:function(t){delete provides[t]},get:function(t){return i[t]}}}),t("skylark-fw-model/sync",["skylark-langx/langx","./models","./backends/registry"],function(t,e,i){return e.sync=function(e,r,n){if(!n.backend)throw new Error("The backend is not specified");var s=i.get(n.backend);if(!s)throw new Error("The backend is not defined:"+n.backend);var a=s.sync;if(!a)throw new Error("The backend sync method is not defined:"+n.backend);var o=t.mixin({},s.options,n);return a.apply(this,[e,r,o])}}),t("skylark-fw-model/backends/ajaxSync",["skylark-langx/langx","../models"],function(t,e){var i={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};return e.backends.ajaxSync=function(r,n,s){var a=i[r];t.defaults(s||(s={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var o={type:a,dataType:"json"};s.url||(o.url=t.result(n,"url")||urlError());null!=s.data||!n||"create"!==r&&"update"!==r&&"patch"!==r||(o.contentType="application/json",o.data=JSON.stringify(s.attrs||n.toJSON(s)));s.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{entity:o.data}:{});if(s.emulateHTTP&&("PUT"===a||"DELETE"===a||"PATCH"===a)){o.type="POST",s.emulateJSON&&(o.data._method=a);var c=s.beforeSend;s.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",a),c)return c.apply(this,arguments)}}"GET"===o.type||s.emulateJSON||(o.processData=!1);var l=s.error;s.error=function(t,e,i){s.textStatus=e,s.errorThrown=i,l&&l.call(s.context,t,e,i)};var h=s.xhr=t.Xhr.request(t.mixin(o,s));return n.trigger("request",n,h,s),h}}),t("skylark-fw-model/backends/localSync",["skylark-langx/langx","../models"],function(t,e){function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}var r=t.klass({_construct:function(t){this.name=t;var e=this.localStorage().getItem(this.name);this.records=e&&e.split(",")||[]},save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(t){return t.id||(t.id=i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i(),t.set(t.idAttribute,t.id)),this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),this.records.push(t.id.toString()),this.save(),this.find(t)},update:function(t){return this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),_.include(this.records,t.id.toString())||this.records.push(t.id.toString()),this.save(),this.find(t)},find:function(t){return this.jsonData(this.localStorage().getItem(this.name+"-"+t.id))},findAll:function(){return _(this.records).chain().map(function(t){return this.jsonData(this.localStorage().getItem(this.name+"-"+t))},this).compact().value()},destroy:function(t){return!t.isNew()&&(this.localStorage().removeItem(this.name+"-"+t.id),this.records=_.reject(this.records,function(e){return e===t.id.toString()}),this.save(),t)},localStorage:function(){return localStorage},jsonData:function(t){return t&&JSON.parse(t)}});function n(e,i,r){var n,s,a=i.localStorage||i.collection.localStorage,o=t.Deferred();try{switch(e){case"read":n=void 0!=i.id?a.find(i):a.findAll();break;case"create":n=a.create(i);break;case"update":n=a.update(i);break;case"delete":n=a.destroy(i)}}catch(t){s=t.code===DOMException.QUOTA_EXCEEDED_ERR&&0===window.localStorage.length?"Private browsing is unsupported":t.message}return n?(i.trigger("sync",i,n,r),r&&r.success&&r.success(n),o&&o.resolve(n)):(s=s||"Record Not Found",r&&r.error&&r.error(s),o&&o.reject(s)),r&&r.complete&&r.complete(n),o&&o.promise()}return e.backends.LocalStorage=n.LocalStorage=r,e.backends.localSync=n}),t("skylark-fw-model/main",["./models","./Collection","./Entity","./sync","./backends/ajaxSync","./backends/localSync","./backends/registry"],function(t){return t}),t("skylark-fw-model",["skylark-fw-model/main"],function(t){return t})}(i),!n){var o=r("skylark-langx/skylark");s?module.exports=o:e.skylarkjs=o}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-fw-model.js.map
